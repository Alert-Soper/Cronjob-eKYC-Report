name: Daily Grafana Report

on:
  schedule:
    - cron: '0 9 * * *'
  push:
    branches:
    - main
  workflow_dispatch:

env:
  GRAFANA_URL: 'http://122.8.149.46:8088/'
  DASHBOARD_UID: 'feao75j1yb474f'
  PANEL_IDS: '2,28,41,42,1'
  LINE_GROUP_ID: 'Cd28550496fd213d14a4b8aa42f5215b6'

jobs:
  generate-and-send-report:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pillow python-dotenv file

    - name: Download Grafana graphs
      env:
        GRAFANA_TOKEN: ${{ secrets.GRAFANA_TOKEN }}
      run: |
        IFS=',' read -ra PANELS <<< "$PANEL_IDS"
        for panel_id in "${PANELS[@]}"; do
          echo "Downloading panel $panel_id"
          
          # ดาวน์โหลดด้วย curl และเก็บ output ไว้ตรวจสอบ
          curl_response=$(curl -v -H "Authorization: Bearer $GRAFANA_TOKEN" \
            "$GRAFANA_URL/render/d-solo/$DASHBOARD_UID?panelId=$panel_id&width=800&height=600&from=now-1d&to=now" \
            -o "grafana_panel_$panel_id.png" 2>&1)
          
          echo "Curl response:"
          echo "$curl_response"
          
          # ตรวจสอบประเภทไฟล์
          if file "grafana_panel_$panel_id.png" | grep -q 'PNG image'; then
            echo "File is valid PNG, converting to JPG"
            python -c "from PIL import Image; img = Image.open('grafana_panel_$panel_id.png'); img.save('grafana_panel_$panel_id.jpg', quality=85, optimize=True)"
            rm "grafana_panel_$panel_id.png"
          else
            echo "ERROR: Downloaded file is not a valid PNG image"
            echo "File content:"
            head -c 200 "grafana_panel_$panel_id.png"  # แสดงส่วนต้นของไฟล์
            exit 1
          fi
        done

    # ...ขั้นตอนอื่นๆ (Send to Line Group, Upload artifacts) ...
